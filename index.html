<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>搵樓 CP 值計算機 (連線版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK (多人連線核心) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
        .slide-enter-from, .slide-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="text-gray-800">

<div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 shadow-2xl relative pb-24">
    
    <!-- 頂部導航欄 -->
    <header :class="isOnline ? 'bg-green-600' : 'bg-indigo-600'" class="text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-50 transition-colors duration-500">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-wide">
                    {{ isOnline ? '雲端搵樓' : '單機搵樓' }}
                </h1>
                <p class="text-white/80 text-xs mt-1">
                    {{ isOnline ? '已連線：資料與朋友同步中' : '資料僅存在此手機' }}
                </p>
            </div>
            <!-- 設定按鈕 (齒輪) -->
            <button @click="showSettings = true" class="bg-white/20 p-2 rounded-full backdrop-blur-sm hover:bg-white/30 transition">
                <i class="fas" :class="isOnline ? 'fa-cloud text-white' : 'fa-cog text-white'"></i>
            </button>
        </div>
    </header>

    <!-- 設定視窗 (貼上 Firebase Config 的地方) -->
    <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold mb-2">多人連線設定</h3>
            <p class="text-xs text-gray-500 mb-4">請貼上 Firebase Config 代碼 (支援直接貼上 const firebaseConfig = ... )。</p>
            
            <textarea v-model="firebaseConfigInput" placeholder='例如: { apiKey: "AIza...", ... }' 
                class="w-full h-32 text-xs p-2 border rounded-lg bg-gray-50 mb-4 font-mono focus:ring-2 focus:ring-green-500 outline-none"></textarea>
            
            <div class="flex gap-2">
                <button @click="saveConfig" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">儲存並連線</button>
                <button @click="showSettings = false" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">關閉</button>
            </div>
            <button @click="resetToLocal" class="w-full mt-2 text-xs text-red-400 underline p-2 text-center">重置回單機版</button>
        </div>
    </div>

    <main class="p-4 space-y-6">

        <!-- 輸入表單 -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-plus-circle text-indigo-500 mr-2"></i> 新增盤源
            </h2>
            
            <form @submit.prevent="addProperty" class="space-y-4">
                <!-- 名稱 -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">名稱 / 座數</label>
                    <input v-model="form.name" required type="text" placeholder="例如：太古城 1座 中層" 
                        class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- 上傳相片 -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">相片 (會自動壓縮)</label>
                    <div class="relative">
                        <input type="file" @change="handleImageUpload" accept="image/*" class="hidden" id="fileInput">
                        <label for="fileInput" class="flex items-center justify-center w-full h-12 bg-gray-100 rounded-xl cursor-pointer border-2 border-dashed border-gray-300 hover:bg-gray-200 transition">
                            <span v-if="!form.image" class="text-gray-400 text-sm"><i class="fas fa-camera mr-2"></i> 上傳相片</span>
                            <span v-else class="text-green-600 text-sm"><i class="fas fa-check mr-2"></i> 已選取相片</span>
                        </label>
                    </div>
                    <img v-if="form.image" :src="form.image" class="mt-2 h-24 w-full object-cover rounded-lg">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- 總價 -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">總價 (萬元)</label>
                        <input v-model.number="form.price" required type="number" step="0.1" placeholder="600" 
                            class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- 面積 -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">實用面積 (呎)</label>
                        <input v-model.number="form.area" required type="number" placeholder="450" 
                            class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- 自動計算呎價顯示 -->
                <div class="bg-indigo-50 p-3 rounded-xl flex justify-between items-center border border-indigo-100">
                    <span class="text-xs text-indigo-400 font-bold uppercase">自動計算呎價</span>
                    <span class="text-lg font-bold text-indigo-700">
                        {{ calculatedSqftPrice ? '$' + formatNumber(calculatedSqftPrice) : '---' }} / 呎
                    </span>
                </div>

                <!-- 景觀與裝修 -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">景觀 (1-5)</label>
                        <div class="flex bg-gray-50 rounded-xl border border-gray-200 overflow-hidden h-[46px]">
                            <button type="button" v-for="n in 5" :key="n" @click="form.viewScore = n"
                                class="flex-1 text-sm transition-colors flex items-center justify-center"
                                :class="form.viewScore >= n ? 'bg-yellow-400 text-white' : 'text-gray-300'">
                                ★
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">裝修狀況</label>
                        <button type="button" @click="form.hasRenovation = !form.hasRenovation"
                            class="w-full h-[46px] rounded-xl border transition-all text-xs font-bold flex items-center justify-center gap-2"
                            :class="form.hasRenovation ? 'bg-green-100 border-green-500 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-400'">
                            <i class="fas" :class="form.hasRenovation ? 'fa-check-circle' : 'fa-circle'"></i>
                            {{ form.hasRenovation ? '已有裝修' : '需裝修' }}
                        </button>
                    </div>
                </div>

                <button type="submit" :disabled="isUploading"
                    class="w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-xl text-sm px-5 py-3.5 shadow-lg shadow-indigo-500/30 transition-all active:scale-95 disabled:opacity-50">
                    {{ isUploading ? '處理圖片中...' : '加入比較' }}
                </button>
            </form>
        </div>

        <!-- 排行榜列表 -->
        <div v-if="properties.length > 0">
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-lg font-bold text-gray-700">排行榜 <span class="text-xs font-normal text-gray-400">({{ properties.length }} 間)</span></h2>
                <button @click="clearAll" class="text-xs text-red-500 bg-red-50 px-3 py-1 rounded-lg hover:bg-red-100 transition">清除所有</button>
            </div>

            <transition-group name="slide" tag="div" class="space-y-4">
                <div v-for="(prop, index) in sortedProperties" :key="prop.id" 
                    class="relative bg-white rounded-2xl shadow-md overflow-hidden border-b-4 transition-transform hover:scale-[1.01]"
                    :class="index === 0 ? 'border-yellow-400' : 'border-gray-200'">
                    
                    <!-- 排名標籤 -->
                    <div class="absolute top-0 left-0 px-3 py-1 rounded-br-xl text-xs font-bold z-10 shadow-sm"
                        :class="index === 0 ? 'bg-yellow-400 text-yellow-900' : 'bg-gray-600 text-white'">
                        <span v-if="index === 0"><i class="fas fa-crown mr-1"></i>CP王</span>
                        <span v-else>#{{ index + 1 }}</span>
                    </div>

                    <!-- 刪除按鈕 -->
                    <button @click="removeProperty(prop.id)" class="absolute top-2 right-2 w-8 h-8 bg-black/30 hover:bg-red-500 rounded-full flex items-center justify-center text-white z-10 backdrop-blur-sm transition-colors">
                        <i class="fas fa-times"></i>
                    </button>

                    <!-- 相片區域 -->
                    <div class="h-36 w-full bg-gray-200 relative">
                        <img v-if="prop.image" :src="prop.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-300 bg-gray-100">
                            <i class="fas fa-image text-4xl opacity-50"></i>
                        </div>
                        <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-3 pt-10">
                            <h3 class="text-white font-bold text-lg leading-tight truncate shadow-black drop-shadow-md">{{ prop.name }}</h3>
                        </div>
                    </div>

                    <!-- 資訊區域 -->
                    <div class="p-4 grid grid-cols-3 gap-2">
                        <div class="col-span-2 space-y-1">
                            <div class="flex items-baseline gap-2">
                                <span class="text-2xl font-bold text-gray-800">${{ prop.price }}<span class="text-sm font-normal text-gray-500">萬</span></span>
                                <span class="text-xs text-gray-500">{{ prop.area }}呎</span>
                            </div>
                            <div class="text-xs text-indigo-700 font-bold bg-indigo-50 inline-block px-2 py-1 rounded border border-indigo-100">
                                @${{ formatNumber(Math.round(prop.price * 10000 / prop.area)) }}/呎
                            </div>
                            <div class="flex gap-3 text-xs text-gray-500 mt-2">
                                <span class="flex items-center gap-1">
                                    <i class="fas fa-paint-roller" :class="prop.hasRenovation ? 'text-green-500':'text-gray-300'"></i> 
                                    {{ prop.hasRenovation ? '有裝修' : '無裝修' }}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i class="fas fa-binoculars text-blue-400"></i> 
                                    {{ prop.viewScore }} 分
                                </span>
                            </div>
                        </div>

                        <div class="text-right flex flex-col justify-center border-l border-gray-100 pl-2">
                            <span class="text-[10px] text-gray-400 uppercase tracking-widest">CP值</span>
                            <span class="text-3xl font-black text-indigo-600">{{ prop.score }}</span>
                        </div>
                    </div>
                </div>
            </transition-group>
        </div>

        <!-- 空狀態 -->
        <div v-else class="text-center py-12 opacity-40">
            <div class="inline-block p-4 rounded-full bg-gray-200 mb-3">
                <i class="fas fa-house-chimney text-4xl text-gray-400"></i>
            </div>
            <p class="text-gray-500 text-sm font-medium">還沒有資料</p>
            <p class="text-xs text-gray-400 mt-1">輸入上方的資料開始計算</p>
        </div>

    </main>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // 資料狀態
            const properties = ref([]);
            const isOnline = ref(false);
            const showSettings = ref(false);
            const firebaseConfigInput = ref('');
            const isUploading = ref(false);
            const db = ref(null);

            const form = ref({
                name: '',
                price: null,
                area: null,
                viewScore: 3,
                hasRenovation: false,
                image: null
            });

            // 1. 自動計算呎價 (顯示用)
            const calculatedSqftPrice = computed(() => {
                if (form.value.price && form.value.area) {
                    return Math.round((form.value.price * 10000) / form.value.area);
                }
                return null;
            });

            // 2. 初始化 (檢查是否有存過 Config)
            onMounted(() => {
                const savedConfig = localStorage.getItem('fb_config');
                if (savedConfig) {
                    // 如果以前有存過，因為我們改了儲存格式(stringified JSON)，要確保讀取正確
                    // 但這裡 input 其實只需要是字串供顯示即可
                    try {
                        const parsed = JSON.parse(savedConfig);
                        // 如果 savedConfig 是完整的 JSON 物件字串，我們轉回格式化的字串顯示在框框裡比較好看（非必要，但貼心）
                        firebaseConfigInput.value = JSON.stringify(parsed, null, 2);
                        initFirebase(parsed);
                    } catch (e) {
                        // 舊版兼容或錯誤格式
                        firebaseConfigInput.value = savedConfig;
                    }
                } else {
                    // 單機模式：讀取 LocalStorage
                    const localData = localStorage.getItem('hkPropData');
                    if (localData) properties.value = JSON.parse(localData);
                }
            });

            // 3. 初始化 Firebase 連線
            const initFirebase = (config) => {
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    }
                    db.value = firebase.firestore();
                    isOnline.value = true;
                    showSettings.value = false;
                    
                    // 監聽雲端資料更新 (Realtime)
                    db.value.collection('properties').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                        properties.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                    
                } catch (e) {
                    console.error(e);
                    alert("連線失敗：設定碼錯誤。請重新檢查 Firebase Config。");
                    isOnline.value = false;
                }
            };

            // 儲存設定並連線 (已升級：支援寬鬆格式)
            const saveConfig = () => {
                try {
                    let input = firebaseConfigInput.value.trim();
                    
                    // 1. 簡單處理：如果使用者貼了 "const firebaseConfig = ... ;"，我們把多餘的去掉
                    if (input.indexOf('=') !== -1) {
                        input = input.split('=')[1].trim();
                    }
                    if (input.endsWith(';')) {
                        input = input.slice(0, -1).trim();
                    }

                    // 2. 使用 new Function 技巧來解析 JS Object Literal (比 JSON.parse 寬容，可吃無引號的 key)
                    // 這是安全的，因為這是 Client side app，使用者貼的是自己的 config
                    const config = new Function('return ' + input)();
                    
                    if (!config.apiKey || !config.projectId) {
                        throw new Error("Missing required fields");
                    }

                    // 存入 LocalStorage 供下次使用
                    localStorage.setItem('fb_config', JSON.stringify(config));
                    
                    // 初始化
                    initFirebase(config);
                    alert("連線成功！現在您和朋友看到的資料是同步的。");
                } catch (e) {
                    console.error(e);
                    alert("格式無法辨識。請直接複製 Firebase 給你的那整段 const firebaseConfig = { ... }; 貼上即可。");
                }
            };

            // 重置回單機版
            const resetToLocal = () => {
                if(confirm("確定要切換回單機版嗎？這會斷開連線。")) {
                    localStorage.removeItem('fb_config');
                    location.reload();
                }
            }

            // 4. 圖片壓縮處理 (避免超過資料庫限制)
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                isUploading.value = true;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // 縮圖寬度固定 400px
                        const scale = 400 / img.width;
                        canvas.width = 400;
                        canvas.height = img.height * scale;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // 壓縮為 JPEG 0.7 品質
                        form.value.image = canvas.toDataURL('image/jpeg', 0.7);
                        isUploading.value = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            // 5. 新增樓盤 (雙模式)
            const addProperty = () => {
                if (!form.value.name || !form.value.price || !form.value.area) return;

                const newProp = {
                    ...form.value,
                    sqftPrice: Math.round((form.value.price * 10000) / form.value.area),
                    timestamp: Date.now()
                };

                if (isOnline.value) {
                    // 存入雲端 Firestore
                    db.value.collection('properties').add(newProp);
                } else {
                    // 存入本機
                    properties.value.push({ id: Date.now(), ...newProp });
                    saveToLocal();
                }

                // 重置表單
                form.value = { name: '', price: null, area: null, viewScore: 3, hasRenovation: false, image: null };
            };

            // 刪除樓盤
            const removeProperty = (id) => {
                if(!confirm('確定要刪除這筆資料嗎？')) return;
                
                if (isOnline.value) {
                    db.value.collection('properties').doc(id).delete();
                } else {
                    properties.value = properties.value.filter(p => p.id !== id);
                    saveToLocal();
                }
            };

            // 清除所有
            const clearAll = () => {
                if(!confirm('確定清除所有紀錄？此動作無法復原。')) return;
                
                if (isOnline.value) {
                    // Firestore 需要一筆筆刪
                    properties.value.forEach(p => {
                        db.value.collection('properties').doc(p.id).delete();
                    });
                } else {
                    properties.value = [];
                    saveToLocal();
                }
            }

            const saveToLocal = () => {
                localStorage.setItem('hkPropData', JSON.stringify(properties.value));
            };

            // CP值 計算邏輯
            const sortedProperties = computed(() => {
                if (properties.value.length === 0) return [];
                const minPrice = Math.min(...properties.value.map(p => p.price));
                const minSqftPrice = Math.min(...properties.value.map(p => p.sqftPrice)); 

                return properties.value.map(p => {
                    let priceScore = (minPrice / p.price) * 40;
                    let sqftScore = (minSqftPrice / p.sqftPrice) * 30;
                    let viewScore = (p.viewScore / 5) * 20;
                    let renoScore = p.hasRenovation ? 10 : 0;
                    let total = priceScore + sqftScore + viewScore + renoScore;
                    return { ...p, score: total.toFixed(1) };
                }).sort((a, b) => b.score - a.score);
            });

            const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);

            return {
                form, properties, sortedProperties, isOnline, showSettings, firebaseConfigInput, isUploading,
                addProperty, removeProperty, clearAll, handleImageUpload, calculatedSqftPrice, formatNumber,
                saveConfig, resetToLocal
            };
        }
    }).mount('#app');
</script>
</body>
</html>
