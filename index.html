<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµæ¨“ CP å€¼è¨ˆç®—æ©Ÿ (Proç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
        .slide-enter-from, .slide-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="text-gray-800">

<div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 shadow-2xl relative pb-24">
    
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <header :class="isOnline ? 'bg-emerald-600' : 'bg-slate-700'" class="text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-50 transition-colors duration-500">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-wide">
                    {{ isOnline ? 'é›²ç«¯æµæ¨“ Pro' : 'å–®æ©Ÿæµæ¨“ Pro' }}
                </h1>
                <p class="text-white/80 text-xs mt-1">
                    {{ isOnline ? 'å·²é€£ç·šï¼šåœ°å€æ•¸æ“šåˆ†æä¸­' : 'é›¢ç·šæ¨¡å¼' }}
                </p>
            </div>
            <button @click="showSettings = true" class="bg-white/20 p-2 rounded-full backdrop-blur-sm hover:bg-white/30 transition">
                <i class="fas" :class="isOnline ? 'fa-signal text-green-300' : 'fa-cog text-white'"></i>
            </button>
        </div>
    </header>

    <!-- è¨­å®šè¦–çª— -->
    <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold mb-2">é€£ç·šè¨­å®š</h3>
            <p class="text-xs text-gray-500 mb-4">è«‹è²¼ä¸Š Firebase Config ä»¥å•Ÿç”¨å¤šäººé€£ç·šã€‚</p>
            <textarea v-model="firebaseConfigInput" placeholder='const firebaseConfig = { ... }' 
                class="w-full h-24 text-xs p-2 border rounded-lg bg-gray-50 mb-4 font-mono focus:ring-2 focus:ring-emerald-500 outline-none"></textarea>
            <div class="flex gap-2">
                <button @click="saveConfig" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg font-bold">å„²å­˜</button>
                <button @click="showSettings = false" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg">é—œé–‰</button>
            </div>
            <button @click="resetToLocal" class="w-full mt-2 text-xs text-red-400 underline p-2 text-center">é‡ç½®å›å–®æ©Ÿç‰ˆ</button>
        </div>
    </div>

    <main class="p-4 space-y-6">

        <!-- è¼¸å…¥è¡¨å–® -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-search-location text-emerald-500 mr-2"></i> æ–°å¢åˆ†æ
            </h2>
            
            <form @submit.prevent="addProperty" class="space-y-4">
                
                <!-- åœ°å€é¸æ“‡ (æ”¹ç‚ºå…©æ­¥ï¼šå…ˆé¸å¤§å€ï¼Œå†é¸å°å€) -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">å€åŸŸ</label>
                        <select v-model="selectedRegion" @change="handleRegionChange" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm appearance-none">
                            <option value="" disabled>è«‹é¸æ“‡</option>
                            <option v-for="(areas, region) in districtData" :key="region" :value="region">
                                {{ region }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">åœ°å€</label>
                        <select v-model="form.district" @change="updateMarketRef" :disabled="!selectedRegion" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm appearance-none disabled:bg-gray-100 disabled:text-gray-400">
                            <option value="" disabled>è«‹é¸æ“‡</option>
                            <template v-if="selectedRegion">
                                <option v-for="(price, area) in districtData[selectedRegion]" :value="area">
                                    {{ area }} (~${{ price }})
                                </option>
                            </template>
                            <option v-else value="" disabled>å…ˆé¸å€åŸŸ</option>
                        </select>
                    </div>
                </div>

                <!-- åç¨± -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">å±‹è‹‘ / å¤§å»ˆåç¨±</label>
                    <input v-model="form.name" required type="text" placeholder="ä¾‹å¦‚ï¼šæ–°æ¸¯åŸ / æµ·æŸèŠ±åœ’" 
                        class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>

                <!-- ç›¸ç‰‡ -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ç¾å ´ç›¸ç‰‡</label>
                    <div class="relative">
                        <input type="file" @change="handleImageUpload" accept="image/*" class="hidden" id="fileInput">
                        <label for="fileInput" class="flex items-center justify-center w-full h-10 bg-gray-100 rounded-xl cursor-pointer border border-dashed border-gray-300 hover:bg-gray-200 transition">
                            <span v-if="!form.image" class="text-gray-400 text-xs"><i class="fas fa-camera mr-2"></i>æ‹ç…§ / ä¸Šå‚³</span>
                            <span v-else class="text-emerald-600 text-xs"><i class="fas fa-check mr-2"></i>å·²é¸å–</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- ç¸½åƒ¹ -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">ç¸½åƒ¹ (è¬å…ƒ)</label>
                        <input v-model.number="form.price" required type="number" step="0.1" placeholder="500" 
                            class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <!-- é¢ç© -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">å¯¦ç”¨é¢ç© (å‘)</label>
                        <input v-model.number="form.area" required type="number" placeholder="400" 
                            class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>

                <!-- åƒ¹æ ¼åˆ†æ (å³æ™‚é‹ç®—) -->
                <div v-if="calculatedSqftPrice" class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-500">æ­¤ç›¤å‘åƒ¹</span>
                        <span class="text-sm font-bold text-gray-800">${{ formatNumber(calculatedSqftPrice) }}</span>
                    </div>
                    <div v-if="marketRefPrice" class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">åŒå€åƒè€ƒ</span>
                        <span class="text-xs text-gray-400">~${{ formatNumber(marketRefPrice) }}</span>
                    </div>
                    <!-- åƒ¹æ ¼æ¢ -->
                    <div v-if="marketRefPrice" class="mt-2 w-full bg-gray-200 rounded-full h-2 overflow-hidden relative">
                        <!-- åƒè€ƒç·š -->
                        <div class="absolute top-0 bottom-0 w-0.5 bg-black z-10" style="left: 50%"></div>
                        <!-- ä½ çš„åƒ¹æ ¼ -->
                        <div class="h-full rounded-full transition-all duration-500"
                             :class="priceRatio < 1 ? 'bg-green-500' : 'bg-red-500'"
                             :style="{ width: Math.min(Math.max((priceRatio * 50), 0), 100) + '%' }">
                        </div>
                    </div>
                    <p v-if="marketRefPrice" class="text-[10px] text-right mt-1" :class="priceRatio < 1 ? 'text-green-600' : 'text-red-500'">
                        {{ priceRatio < 1 ? `ä½æ–¼å¸‚å€¼ ${Math.round((1-priceRatio)*100)}% (æŠµè²·)` : `é«˜æ–¼å¸‚å€¼ ${Math.round((priceRatio-1)*100)}%` }}
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">æ™¯è§€ (1-5)</label>
                        <div class="flex bg-gray-50 rounded-xl border border-gray-200 overflow-hidden h-[42px]">
                            <button type="button" v-for="n in 5" :key="n" @click="form.viewScore = n"
                                class="flex-1 text-xs transition-colors"
                                :class="form.viewScore >= n ? 'bg-yellow-400 text-white' : 'text-gray-300'">â˜…</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">è£ä¿®</label>
                        <button type="button" @click="form.hasRenovation = !form.hasRenovation"
                            class="w-full h-[42px] rounded-xl border transition-all text-xs font-bold flex items-center justify-center gap-1"
                            :class="form.hasRenovation ? 'bg-green-100 border-green-500 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-400'">
                            <i class="fas" :class="form.hasRenovation ? 'fa-check' : 'fa-times'"></i> {{ form.hasRenovation ? 'æœ‰è£' : 'ç„¡è£' }}
                        </button>
                    </div>
                </div>

                <button type="submit" :disabled="isUploading"
                    class="w-full text-white bg-slate-800 hover:bg-slate-900 font-medium rounded-xl text-sm px-5 py-3.5 shadow-lg shadow-slate-500/30 transition-all active:scale-95 disabled:opacity-50">
                    {{ isUploading ? 'è™•ç†ä¸­...' : 'åŠ å…¥æ¯”è¼ƒ' }}
                </button>
            </form>
        </div>

        <!-- æ’è¡Œæ¦œ -->
        <div v-if="properties.length > 0">
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-lg font-bold text-gray-700">åˆ†æçµæœ <span class="text-xs font-normal text-gray-400">({{ properties.length }})</span></h2>
                <button @click="clearAll" class="text-xs text-red-400 bg-red-50 px-2 py-1 rounded">æ¸…é™¤</button>
            </div>

            <transition-group name="slide" tag="div" class="space-y-4">
                <div v-for="(prop, index) in sortedProperties" :key="prop.id" 
                    class="relative bg-white rounded-2xl shadow-md overflow-hidden border-b-4 transition-transform hover:scale-[1.01]"
                    :class="getScoreColor(index)">
                    
                    <!-- æ’å Badge -->
                    <div class="absolute top-0 left-0 px-3 py-1 rounded-br-xl text-xs font-bold z-10 text-white shadow-sm"
                         :class="index === 0 ? 'bg-yellow-500' : 'bg-slate-500'">
                        {{ index === 0 ? 'ğŸ‘‘ CPç‹' : `#${index + 1}` }}
                    </div>

                    <button @click="removeProperty(prop.id)" class="absolute top-2 right-2 w-7 h-7 bg-black/40 hover:bg-red-500 rounded-full flex items-center justify-center text-white z-20 backdrop-blur-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>

                    <!-- å¡ç‰‡å…§å®¹ -->
                    <div class="flex h-32">
                        <!-- å·¦å´åœ–ç‰‡ -->
                        <div class="w-1/3 relative bg-gray-200">
                            <img v-if="prop.image" :src="prop.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-300">
                                <i class="fas fa-home text-2xl"></i>
                            </div>
                            <!-- åœ°å€æ¨™ç±¤ -->
                            <div class="absolute bottom-0 inset-x-0 bg-black/60 p-1 text-center">
                                <span class="text-[10px] text-white font-bold truncate block">{{ prop.district || 'æœªåˆ†å€' }}</span>
                            </div>
                        </div>

                        <!-- å³å´è³‡è¨Š -->
                        <div class="w-2/3 p-3 flex flex-col justify-between">
                            <div>
                                <h3 class="font-bold text-gray-800 leading-tight truncate">{{ prop.name }}</h3>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <span class="text-xl font-bold text-slate-700">${{ prop.price }}</span>
                                    <span class="text-xs text-gray-500">è¬ / {{ prop.area }}å‘</span>
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 font-medium">
                                        @{{ formatNumber(prop.sqftPrice) }}
                                    </span>
                                    <!-- é¡¯ç¤ºç›¸å°æ–¼è©²å€çš„æº¢åƒ¹ -->
                                    <span v-if="prop.marketDiff" class="text-[10px] px-1.5 py-0.5 rounded font-bold"
                                          :class="prop.marketDiff < 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                        {{ prop.marketDiff < 0 ? 'ä½æ°´' : 'é«˜æ°´' }} {{ Math.abs(prop.marketDiff) }}%
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-end border-t border-gray-100 pt-2">
                                <div class="flex gap-2 text-xs text-gray-400">
                                    <span><i class="fas fa-tools" :class="prop.hasRenovation?'text-emerald-500':''"></i></span>
                                    <span><i class="fas fa-star text-yellow-400"></i> {{ prop.viewScore }}</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-[10px] text-gray-400 block uppercase">CP åˆ†æ•¸</span>
                                    <span class="text-2xl font-black text-slate-800 leading-none">{{ prop.score }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition-group>
        </div>

        <div v-else class="text-center py-12 opacity-40">
            <i class="fas fa-chart-pie text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-400 text-sm">é¸æ“‡åœ°å€ï¼Œå³æ™‚åˆ†ææ€§åƒ¹æ¯”</p>
        </div>

    </main>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // 2025/2026 æ¨¡æ“¬å¸‚å ´æ•¸æ“š (æ›´åŠ ç´°åˆ†)
    const HK_DISTRICT_DATA = {
        'æ¸¯å³¶å€': {
            'ä¸­è¥¿å€ (ä¸­ç’°/è¥¿ç’°)': 16500,
            'è¥¿åŠå±±/è–„æ‰¶æ—': 17500,
            'ç£ä»”/éŠ…é‘¼ç£': 16000,
            'è·‘é¦¬åœ°/å¤§å‘': 16500,
            'åŒ—è§’/ç‚®å°å±±': 14500,
            'é°‚é­šæ¶Œ/å¤ªå¤': 15000,
            'ç­²ç®•ç£/æŸ´ç£': 12500,
            'é¦™æ¸¯ä»”/é´¨è„·æ´²': 13000
        },
        'ä¹é¾å€': {
            'å°–æ²™å’€/ä½æ•¦': 14000,
            'æ—ºè§’/æ²¹éº»åœ°': 13000,
            'å¥§é‹/å¤§è§’å’€': 14500,
            'é•·æ²™ç£/è”æè§’': 13500,
            'æ·±æ°´åŸ—/å—æ˜Œ': 12000,
            'ç´…ç£¡/é»ƒåŸ”': 14000,
            'å•Ÿå¾·/ä¹é¾åŸ': 16000,
            'ä½•æ–‡ç”°': 15000,
            'é»ƒå¤§ä»™/é‘½çŸ³å±±': 12500,
            'ä¹é¾ç£/ç‰›é ­è§’': 12000,
            'è§€å¡˜/è—ç”°': 12500,
            'æ²¹å¡˜': 13000
        },
        'æ–°ç•Œæ±': {
            'å¤§åœ': 13000,
            'æ²™ç”°': 12500,
            'ç«ç‚­': 12000,
            'é¦¬éå±±': 11500, // æ–°å¢
            'å¤§åŸ”': 10500,
            'ç²‰å¶º/ä¸Šæ°´': 9500,
            'å°‡è»æ¾³': 13000,
            'è¥¿è²¢': 11000
        },
        'æ–°ç•Œè¥¿': {
            'èƒç£': 13000,
            'èƒç£è¥¿/æ·±äº•': 12500,
            'è‘µæ¶Œ': 10000,
            'é’è¡£': 11500,
            'å±¯é–€': 9500,
            'å…ƒæœ—': 10500,
            'å¤©æ°´åœ': 8500,
            'æ±æ¶Œ': 10000
        }
    };

    createApp({
        setup() {
            const properties = ref([]);
            const isOnline = ref(false);
            const showSettings = ref(false);
            const firebaseConfigInput = ref('');
            const isUploading = ref(false);
            const db = ref(null);
            
            // åœ°å€æ•¸æ“š
            const districtData = HK_DISTRICT_DATA;
            const marketRefPrice = ref(null);
            const selectedRegion = ref('');

            const form = ref({
                district: '',
                name: '',
                price: null,
                area: null,
                viewScore: 3,
                hasRenovation: false,
                image: null
            });

            // ç•¶åˆ‡æ›å¤§å€æ™‚ï¼Œé‡ç½®å°å€
            const handleRegionChange = () => {
                form.value.district = '';
                marketRefPrice.value = null;
            };

            // ç•¶é¸æ“‡åœ°å€æ”¹è®Šæ™‚ï¼Œæ›´æ–°åƒè€ƒåƒ¹
            const updateMarketRef = () => {
                if (!form.value.district || !selectedRegion.value) return;
                // ç›´æ¥å¾é¸å®šçš„å€åŸŸç²å–åƒ¹æ ¼
                if (districtData[selectedRegion.value] && districtData[selectedRegion.value][form.value.district]) {
                    marketRefPrice.value = districtData[selectedRegion.value][form.value.district];
                }
            };

            const calculatedSqftPrice = computed(() => {
                if (form.value.price && form.value.area) {
                    return Math.round((form.value.price * 10000) / form.value.area);
                }
                return null;
            });

            // è¨ˆç®—ç›®å‰åƒ¹æ ¼èˆ‡åƒè€ƒåƒ¹çš„æ¯”ç‡ (ä¾‹å¦‚ 0.8 ä»£è¡¨ä½æ–¼å¸‚å€¼ 20%)
            const priceRatio = computed(() => {
                if (!calculatedSqftPrice.value || !marketRefPrice.value) return 1;
                return calculatedSqftPrice.value / marketRefPrice.value;
            });

            onMounted(() => {
                const savedConfig = localStorage.getItem('fb_config');
                if (savedConfig) {
                    // å˜—è©¦è§£æè¨­å®š
                    try {
                        let displayVal = savedConfig;
                        try {
                            const parsed = JSON.parse(savedConfig);
                            displayVal = JSON.stringify(parsed, null, 2);
                            initFirebase(parsed);
                        } catch { 
                            // èˆŠæ ¼å¼å…¼å®¹
                            initFirebase(JSON.parse(savedConfig)); 
                        }
                        firebaseConfigInput.value = displayVal;
                    } catch (e) { console.error(e); }
                } else {
                    const localData = localStorage.getItem('hkPropData_Pro');
                    if (localData) properties.value = JSON.parse(localData);
                }
            });

            const initFirebase = (config) => {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    db.value = firebase.firestore();
                    isOnline.value = true;
                    showSettings.value = false;
                    db.value.collection('properties_pro').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                        properties.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                } catch (e) {
                    alert("é€£ç·šè¨­å®šæœ‰èª¤ï¼Œè«‹æª¢æŸ¥ Config");
                    isOnline.value = false;
                }
            };

            const saveConfig = () => {
                try {
                    let input = firebaseConfigInput.value.trim();
                    if (input.includes('=')) input = input.split('=')[1].trim();
                    if (input.endsWith(';')) input = input.slice(0, -1).trim();
                    const config = new Function('return ' + input)();
                    localStorage.setItem('fb_config', JSON.stringify(config));
                    initFirebase(config);
                    alert("é€£ç·šæˆåŠŸï¼");
                } catch (e) {
                    alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç›´æ¥è²¼ä¸Š Firebase çµ¦ä½ çš„ä»£ç¢¼");
                }
            };

            const resetToLocal = () => {
                if(confirm("ç¢ºå®šå›åˆ°å–®æ©Ÿç‰ˆï¼Ÿ")) {
                    localStorage.removeItem('fb_config');
                    location.reload();
                }
            }

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                isUploading.value = true;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 400 / img.width;
                        canvas.width = 400;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        form.value.image = canvas.toDataURL('image/jpeg', 0.6);
                        isUploading.value = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            const addProperty = () => {
                if (!form.value.name || !form.value.price || !form.value.area) return;

                const sqft = Math.round((form.value.price * 10000) / form.value.area);
                
                // æŸ¥æ‰¾è©²å€åƒè€ƒåƒ¹
                let refPrice = sqft;
                // å¦‚æœå·²é¸å€åŸŸå’Œåœ°å€ï¼Œç›´æ¥ç²å–
                if (selectedRegion.value && districtData[selectedRegion.value] && districtData[selectedRegion.value][form.value.district]) {
                     refPrice = districtData[selectedRegion.value][form.value.district];
                } else {
                    // ä¿éšªèµ·è¦‹çš„å‚™ç”¨æŸ¥æ‰¾
                    for (const region in districtData) {
                        if (districtData[region][form.value.district]) {
                            refPrice = districtData[region][form.value.district];
                            break;
                        }
                    }
                }

                // è¨ˆç®—èˆ‡å¸‚åƒ¹çš„å·®ç•°ç™¾åˆ†æ¯” (è² æ•¸ä»£è¡¨ä¾¿å®œï¼Œæ­£æ•¸ä»£è¡¨è²´)
                const marketDiff = Math.round(((sqft - refPrice) / refPrice) * 100);

                const newProp = {
                    ...form.value,
                    sqftPrice: sqft,
                    marketDiff: marketDiff, // å„²å­˜é€™å€‹é‡è¦çš„æŒ‡æ¨™
                    timestamp: Date.now()
                };

                if (isOnline.value) {
                    db.value.collection('properties_pro').add(newProp);
                } else {
                    properties.value.push({ id: Date.now(), ...newProp });
                    saveToLocal();
                }

                form.value = { district: '', name: '', price: null, area: null, viewScore: 3, hasRenovation: false, image: null };
                selectedRegion.value = ''; // é‡ç½®å€åŸŸé¸æ“‡
                marketRefPrice.value = null;
            };

            const removeProperty = (id) => {
                if(!confirm('åˆªé™¤?')) return;
                if (isOnline.value) db.value.collection('properties_pro').doc(id).delete();
                else {
                    properties.value = properties.value.filter(p => p.id !== id);
                    saveToLocal();
                }
            };

            const clearAll = () => {
                if(!confirm('æ¸…é™¤æ‰€æœ‰?')) return;
                if (isOnline.value) properties.value.forEach(p => db.value.collection('properties_pro').doc(p.id).delete());
                else {
                    properties.value = [];
                    saveToLocal();
                }
            };

            const saveToLocal = () => {
                localStorage.setItem('hkPropData_Pro', JSON.stringify(properties.value));
            };

            // ---- æ ¸å¿ƒæ¼”ç®—æ³•å‡ç´š ----
            const sortedProperties = computed(() => {
                if (properties.value.length === 0) return [];

                // 1. æ‰¾å‡ºåˆ—è¡¨ä¸­çš„æœ€å€¼ï¼Œç”¨æ–¼ç›¸å°è©•åˆ†
                const minPrice = Math.min(...properties.value.map(p => p.price));
                const minSqft = Math.min(...properties.value.map(p => p.sqftPrice));

                return properties.value.map(p => {
                    // A. çµ•å°åƒ¹æ ¼åˆ†æ•¸ (30%) - è¶Šå¹³è¶Šå¥½
                    let priceScore = (minPrice / p.price) * 30;

                    // B. å‘åƒ¹åˆ†æ•¸ (20%) - è¶Šå¹³è¶Šå¥½
                    let sqftScore = (minSqft / p.sqftPrice) * 20;

                    // C. å¸‚å ´æ¯”è¼ƒåˆ†æ•¸ (20%) - é€™æ˜¯æ–°çš„é‡é»
                    // å¦‚æœ marketDiff æ˜¯ -10 (ä½æ°´10%)ï¼Œåˆ†æ•¸æ‡‰è©²é«˜
                    // é‚è¼¯ï¼šåŸºæº–åˆ† 10 åˆ†ã€‚æ¯ä½æ°´ 1% åŠ  0.5 åˆ†ï¼Œæ¯é«˜æ°´ 1% æ¸› 0.5 åˆ†ã€‚
                    // é™åˆ¶æœ€å¤§ 20 åˆ†ï¼Œæœ€å° 0 åˆ†
                    let diff = p.marketDiff || 0; // è² æ•¸æ˜¯å¥½äº‹
                    let marketScore = 10 + (diff * -0.5); 
                    marketScore = Math.max(0, Math.min(20, marketScore));

                    // D. æ™¯è§€ (20%)
                    let viewScore = (p.viewScore / 5) * 20;

                    // E. è£ä¿® (10%)
                    let renoScore = p.hasRenovation ? 10 : 0;

                    let total = priceScore + sqftScore + marketScore + viewScore + renoScore;

                    return { ...p, score: total.toFixed(1) };
                }).sort((a, b) => b.score - a.score);
            });

            const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);
            
            const getScoreColor = (index) => {
                if (index === 0) return 'border-yellow-400 ring-2 ring-yellow-100';
                if (index === 1) return 'border-gray-300';
                if (index === 2) return 'border-orange-200';
                return 'border-gray-100';
            };

            return {
                form, properties, sortedProperties, isOnline, showSettings, firebaseConfigInput, isUploading,
                districtData, marketRefPrice, calculatedSqftPrice, priceRatio, selectedRegion, handleRegionChange,
                addProperty, removeProperty, clearAll, handleImageUpload, updateMarketRef, 
                formatNumber, saveConfig, resetToLocal, getScoreColor
            };
        }
    }).mount('#app');
</script>
</body>
</html>
